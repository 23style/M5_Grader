# M5Stack 柿の選果機プログラム

このリポジトリは、M5Stackを利用した柿の選果機のプログラムを提供します。
プログラムは、Wi-Fi接続、重量測定、音声出力を統合し、選果作業の効率化を目指しています。

## 特徴

- **Wi-Fi接続**  
  `config.json` に記載したSSIDとパスワードを利用してインターネットに接続します。

- **Google Apps Script連携**  
  測定結果をGoogle スプレッドシートに記載します。オフラインモードに切り替えることもできます。

- **デバイス識別**  
  `config.json` 内の `device_id` により、複数台のデバイスを個別に識別します。

- **重量測定と選果処理**  
  重量センサを用いて柿の重さを計測し、設定した基準に基づいた選果処理を行います。

- **音声出力**  
  測定結果や選果状況を音声でフィードバックし、作業状況をユーザに通知します。

## Google Apps Script（GAS）の設定

M5Stackから送信されたデータを処理し、スプレッドシートに保存するために、Google Apps Script（GAS）を設定します。

### 1. Google Apps Scriptの作成

1. **Google スプレッドシート**を作成し、"Sheet1"という名前のシートを作成します。
2. **Google Apps Script（GAS）エディタを開く**
   - スプレッドシートを開き、メニューの「拡張機能」→「Apps Script」を選択。
3. **スクリプトを追加**
   - `webHook.gs` の内容をコピーし、Apps Scriptのエディタに貼り付けます。

### 2. GASのデプロイ

1. 「デプロイ」→「新しいデプロイ」を選択
2. 「種類を選択」で「ウェブアプリ」を選択
3. 次のユーザーとして実行を「自分」に設定
4. 「アクセスできるユーザー」を「全員（匿名）」に変更
5. デプロイ後に表示される「ウェブアプリのURL」をコピーし、`config.json` の `gas_url` に設定

### 3. GASの処理内容

このスクリプトは、M5Stackから送信されたデータをGoogle スプレッドシートに記録します。基本的な動作は以下の通りです。

1. `doPost(e)` 関数がHTTPリクエストを受け取る
2. JSONデータを解析し、スプレッドシートに保存
3. 処理が完了すると、HTTPレスポンスを返す

スクリプトの詳細なコードは `webHook.gs` に記述されています。

## M5Stackへのインストール
1. **SDカードの準備**  
   config.jsonをSDカード直下に配置。
   wavフォルダをSDカード直下に配置。
   wavファイルをwavフォルダに配置。

2. **Wi-Fi設定の編集**  
   ルートディレクトリにある `config.json` ファイルを開き、Wi-Fi接続情報、Google Apps ScriptのエンドポイントURL、`device_id` を設定します。  
   例:
   ```json
   {
     "wifi": {
       "ssid": "yourSSID",
       "password": "password"
     },
     "gas_url": "https://script.google.com/macros/..../exec",
     "device_id": 1
   }
   ```

## 使い方と機能

1. **デバイス起動**  
   M5Stackの電源を入れると、自動的にWi-Fiに接続し、設定したネットワーク情報に基づいて通信が開始されます。

2. **重量測定と選果処理**  
   接続された重量センサにより柿の重さを計測し、設定された基準に従って選果処理を実施します。

3. **音声出力によるフィードバック**  
   測定結果や選果状況が音声出力によりユーザへ通知されます。

4. **データ送信**  
   測定データがGoogle Apps Scriptのエンドポイントへ送信され、スプレッドシートに保存されます。

5.**オフラインモード**
  測定データを記録したくない場合は、Cボタンでオフラインモードの切り替えができます。

  Aボタンのゼロリセット（風袋引き）機能
測定時に風袋（容器などの重量）をリセットし、正確な柿の重量を測定できます。

Bボタンのキャリブレーション機能（初回必須）
測定精度を向上させるために、100gの分銅を使用してキャリブレーションを行います。設定値はM5Stackに保存されます。

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。詳細は[LICENSE](LICENSE)ファイルをご参照ください。

## お問い合わせ

ご質問や改善提案がございましたら、GitHub上でIssueを作成するか、プルリクエストをお送りください。

