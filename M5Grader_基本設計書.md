# M5Grader システム基本設計書

## 1. システム概要

### 1.1 システム名
M5Grader - 汎用重量分類システム

### 1.2 システム目的
M5Stack Coreを使用した、重量に基づく製品の自動分類・音声案内システム。設定ファイルによる柔軟な分類基準変更により、様々な製品（果物、野菜等）の選果作業に対応可能。

### 1.3 対象ハードウェア
- M5Stack Core
- TAL221ロードセル（重量センサー）
- M5UnitWeightI2C（重量測定ユニット）
- SDカード
- 内蔵スピーカー

## 2. 要件定義

### 2.1 機能要件

#### 2.1.1 重量測定機能
- 連続的な重量測定
- 測定値の安定性判定
- オフセット調整機能
- キャリブレーション機能

#### 2.1.2 製品分類機能
- 重量に基づく規格判定
- 動的な分類基準設定
- 複数規格への対応

#### 2.1.3 音声案内機能
- 規格別音声再生
- システム状態音声通知
- WAVファイル形式対応

#### 2.1.4 表示機能
- 規格名の画面表示
- 背景色による視覚的識別
- 重量値表示
- 測定状態表示
- デバイスID表示（画面右上に常時表示）

#### 2.1.5 設定管理機能
- SDカードベース設定ファイル
- 製品別設定の動的読み込み
- エラー時詳細表示

#### 2.1.6 ネットワーク機能
- WiFi接続機能
- WiFi接続失敗時の自動オフライン切替
- Google Apps Script連携（HTTP POST）
- 測定データ自動送信（規格確定時）
- オフラインモード対応
- HTTP リダイレクト処理（302エラー対応）
- セキュア通信対応（SSL/TLS）

### 2.2 非機能要件

#### 2.2.1 性能要件
- 測定間隔：200ms
- 安定判定：5サンプル平均
- 応答時間：1秒以内

#### 2.2.2 信頼性要件
- 設定エラー時の適切な中断処理
- 自動オフセット調整（5分間隔）
- 音声ファイル不存在時の継続動作
- WiFi接続失敗時の自動オフライン切替
- ネットワーク通信エラー時の継続動作
- HTTPリダイレクト自動処理

#### 2.2.3 操作性要件
- ボタン操作による基本機能実行
- 視覚的フィードバック（色分け表示）
- 音声による直感的な操作案内

## 3. システム仕様

### 3.1 ハードウェア仕様

#### 3.1.1 重量センサー
- センサー：TAL221ロードセル
- 測定範囲：設定可能（config.jsonで指定）
- 精度：1g単位
- インターフェース：I2C通信

#### 3.1.2 表示装置
- ディスプレイ：M5Stack Core内蔵LCD
- 解像度：320×240ピクセル
- 表示内容：規格名、重量値、状態表示、デバイスID
- 画面レイアウト：
  - 中央：規格名（大きく表示、背景色付き）
  - 下部：重量値（190px位置）
  - 右下：測定状態（230px位置）
  - 右上：デバイスID（白背景四角囲み、最上位レイヤー）

#### 3.1.3 音声出力
- スピーカー：M5Stack Core内蔵
- ファイル形式：WAV
- 音量：設定可能

### 3.2 ソフトウェア仕様

#### 3.2.1 設定ファイル仕様（config.json）
```json
{
  "wifi": {
    "ssid": "WiFiネットワーク名",
    "password": "WiFiパスワード"
  },
  "gas_url": "Google Apps ScriptのURL",
  "device_id": "デバイス識別番号",
  "product_settings": {
    "product_name": "製品名",
    "min_weight": "最小測定重量(g)",
    "max_weight": "最大測定重量(g)",
    "stability_threshold": "安定判定閾値(g)",
    "grades": [
      {
        "name": "規格名",
        "min_weight": "最小重量(g)",
        "max_weight": "最大重量(g)",
        "sound_file": "音声ファイルパス",
        "color": "16進カラーコード"
      }
    ]
  }
}
```

#### 3.2.2 測定状態定義
- **STATE_READY**: 測定準備完了
- **STATE_MEASURING**: 測定中（値が変動中）
- **STATE_STABLE**: 測定値安定（規格確定）
- **STATE_ZERO**: ゼロ状態（物体なし）

#### 3.2.3 ボタン機能
- **ボタンA**: オフセット設定
- **ボタンB**: キャリブレーション実行
- **ボタンC**: オンライン/オフライン切替

### 3.3 ファイル構成
- **SDカードルート**:
  - `config.json` - システム設定ファイル
  - `*.wav` - 規格別音声ファイル
  - `info.wav` - システム情報音
  - `zero.wav` - ゼロ検出音
  - `error.wav` - エラー音

## 4. 基本動作フロー

### 4.1 システム起動
1. M5Stack Core初期化
2. SDカード初期化確認
3. config.json読み込み・検証
4. 重量センサー初期化
5. WiFi接続（オンラインモード時）
6. キャリブレーション係数読み込み
7. 初期オフセット設定

### 4.2 通常測定フロー
1. 重量値取得（6サンプル平均）
2. 安定性判定（5サンプル履歴）
3. 測定状態更新
4. 規格判定（重量範囲マッチング）
5. 画面表示更新（規格名・背景色）
6. 音声再生（規格確定時）
7. データ送信（オンラインモード時、エラー処理なし）

### 4.3 エラーハンドリング
1. SDカード初期化失敗 → 赤画面表示・処理中断
2. config.json不存在 → 赤画面表示・処理中断
3. JSON解析エラー → 赤画面表示・処理中断
4. 必須設定項目不足 → 赤画面表示・処理中断
5. 重量センサーエラー → エラー音・再試行
6. WiFi接続失敗 → 警告表示・自動オフライン切替
7. GAS通信エラー → 処理継続（エラー表示なし）

### 4.4 自動機能
- **自動オフセット**: 5分間隔で軽量物体検出時に実行
- **自動データ送信**: 規格確定時にGASへ送信（エラー無視）
- **安定性検出**: 連続5サンプルが閾値内で安定判定
- **HTTPリダイレクト追跡**: 302リダイレクトの自動処理

## 5. 運用仕様

### 5.1 製品切替手順
1. M5Stack電源OFF
2. SDカードを取り出し
3. PCでconfig.json編集
4. 対応音声ファイル配置
5. SDカードを戻しM5Stack起動

### 5.2 設定例

#### 5.2.1 柿選果設定
- 規格：6L, 5L, 4L, 3L, 2L, L, M, S, 2S, 3S
- 重量範囲：50g〜999g（10段階）
- 色分け：赤→紫→青→緑→黄→オレンジ→グレー

#### 5.2.2 りんご選果設定
- 規格：特A, A, B
- 重量範囲：300-400g, 200-299g, 100-199g
- 色分け：赤、緑、青

### 5.3 メンテナンス
- 定期キャリブレーション（100g標準重量使用）
- SDカード容量確認
- 音声ファイル整合性確認
- WiFi接続状態確認
- GAS URL有効性確認
- ネットワーク通信状況確認

## 6. 制約事項

### 6.1 技術的制約
- config.jsonは必須（デフォルト設定なし）
- SDカード必須（本体ストレージ不使用）
- WiFi環境必須（オンラインモード使用時）
- 音声ファイルはWAV形式のみ

### 6.2 運用制約
- 設定変更時はシステム再起動必須
- 同時測定不可（1個ずつ測定）
- 環境温度による重量ドリフト可能性

## 7. 拡張性

### 7.1 対応可能な追加機能
- 規格数の増減（config.json編集）
- 新製品対応（設定ファイル変更）
- 音声言語変更（音声ファイル差し替え）
- 表示色カスタマイズ（16進カラー指定）

### 7.2 システム連携
- Google Apps Script経由でのデータ収集
- HTTPS通信によるセキュア通信
- HTTPリダイレクト対応による高い互換性
- 外部システムへのAPI連携拡張可能
- 複数台M5Stackの同時運用対応